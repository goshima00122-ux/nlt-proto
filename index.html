<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>オンライン問題（試作）</title>
  <style>
    :root { --gap:16px; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 0; background:#fafafa; color:#111; }
    .wrap { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 16px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    .section { margin-top: 16px; }
    label { font-weight:600; margin-right: 6px; }
    select, input[type="text"], button { font-size: 16px; }
    select, input[type="text"] { padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
    button { padding:8px 14px; border:1px solid #111; background:#111; color:#fff; border-radius:10px; cursor:pointer; }
    button.secondary { background:#fff; color:#111; border-color:#e5e7eb; }
    button.ghost { background:transparent; border-color:transparent; color:#111; }
    .muted { color:#6b7280; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .hidden { display:none; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .ansbtns button { width:48px; height:40px; font-size:18px; }
    .ok { color:#059669; }
    .ng { color:#dc2626; }
    ul { margin: 8px 0 0 16px; padding:0; }
    li { margin: 3px 0; }
    .bottom { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:24px; flex-wrap:wrap; }
    .btns { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>オンライン問題（試作）</h1>

    <!-- 上部コントロール -->
    <div class="card">
      <div class="row">
        <div class="row">
          <label for="unit">単元：</label>
          <select id="unit">
            <option value="fraction">分数の大小</option>
            <option value="gcd">最大公約数</option>
          </select>
        </div>
        <div class="row">
          <label for="difficulty">難易度：</label>
          <select id="difficulty">
            <option value="easy">やさしい</option>
            <option value="normal" selected>ふつう</option>
            <option value="hard">むずかしい</option>
          </select>
        </div>
        <button id="next">次の問題</button>

        <div class="row" style="margin-left:auto; gap:6px;">
          <span class="muted">学習記録</span>
          <button id="toggleLog" class="secondary">非表示</button>
        </div>
      </div>
    </div>

    <!-- 問題 -->
    <div class="card section">
      <div class="muted mono">（>, <, = のいずれかで答えます／GCDは半角数字）</div>
      <div id="question" style="font-size:18px; margin-top:6px;">問題を読み込み中…</div>

      <div class="section">
        <div class="row">
          <label>答え</label>
          <div class="ansbtns row">
            <button id="btnGt" class="secondary">&gt;</button>
            <button id="btnLt" class="secondary">&lt;</button>
            <button id="btnEq" class="secondary">=</button>
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="answer" type="text" placeholder="例： > / < / = （分数の大小）または 12（最大公約数）" style="flex:1;" />
          <button id="submit">採点</button>
        </div>
        <div id="result" class="section"></div>
      </div>
    </div>

    <!-- 学習記録 -->
    <div id="logCard" class="card section">
      <div class="toolbar">
        <div class="row" style="gap:8px"><strong>学習記録</strong><span id="stats" class="muted"></span></div>
        <button id="toggleMs" class="ghost mono">▶ 詳細（時間ms）を表示</button>
      </div>
      <ul id="log"></ul>
    </div>

    <!-- 先生ダッシュボード（モード：先生で表示） -->
    <div id="dashCard" class="card section hidden">
      <div class="toolbar">
        <strong>先生ダッシュボード</strong>
        <button id="exportCsv" class="secondary">CSVエクスポート</button>
      </div>
      <div id="dashSummary" class="muted mono" style="margin-top:6px;"></div>
      <div style="overflow-x:auto; margin-top:8px;">
        <table id="dashTable" class="mono" style="border-collapse:collapse; width:100%;">
          <thead>
            <tr>
              <th style="border-bottom:1px solid #e5e7eb; text-align:left; padding:4px 6px;">プロフィール</th>
              <th style="border-bottom:1px solid #e5e7eb; text-align:right; padding:4px 6px;">総問数</th>
              <th style="border-bottom:1px solid #e5e7eb; text-align:right; padding:4px 6px;">正解</th>
              <th style="border-bottom:1px solid #e5e7eb; text-align:right; padding:4px 6px;">正答率</th>
              <th style="border-bottom:1px solid #e5e7eb; text-align:right; padding:4px 6px;">分数の大小</th>
              <th style="border-bottom:1px solid #e5e7eb; text-align:right; padding:4px 6px;">最大公約数</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- 画面下：プロフィール＆モード -->
    <div class="bottom">
      <div class="btns">
        <label for="profileSel">プロフィール：</label>
        <select id="profileSel"></select>
        <button id="newProfile" class="secondary">新規プロフィール</button>
        <button id="renameProfile" class="secondary">名称変更</button>
      </div>
      <div class="btns">
        <label for="modeSel">モード：</label>
        <select id="modeSel">
          <option value="learner" selected>学習者</option>
          <option value="teacher">先生</option>
        </select>
      </div>
    </div>
  </div>

  <script>
    // ====== API の場所（Render の URL に合わせて置き換えてOK）======
    const API_BASE = 'https://nlt-proto.onrender.com/api/v1';
    // 他の Render URL の場合は ↑ をあなたの URL に変更してください

    // ====== 状態 ======
    let current = null;
    let logVisible = true;
    let showMs = false;

    // ====== ストレージ（プロフィールごとの記録）======
    const STORE_KEY = 'nlt-proto:profiles';
    const CUR_KEY   = 'nlt-proto:currentProfile';

    function loadProfiles() {
      try { return JSON.parse(localStorage.getItem(STORE_KEY)) || {}; }
      catch { return {}; }
    }
    function saveProfiles(m) { localStorage.setItem(STORE_KEY, JSON.stringify(m)); }
    function ensureInit() {
      const m = loadProfiles();
      if (!Object.keys(m).length) {
        m['学習者A'] = { log: [] };
        saveProfiles(m);
        localStorage.setItem(CUR_KEY, '学習者A');
      }
    }
    ensureInit();

    // ====== 要素 ======
    const $ = id => document.getElementById(id);
    const unitSel = $('unit');
    const diffSel = $('difficulty');
    const nextBtn = $('next');
    const qEl = $('question');
    const ans = $('answer');
    const submit = $('submit');
    const btnGt = $('btnGt'), btnLt = $('btnLt'), btnEq = $('btnEq');
    const resultEl = $('result');

    const toggleLog = $('toggleLog'), logCard = $('logCard');
    const logUl = $('log'), stats = $('stats'), toggleMs = $('toggleMs');

    const profileSel = $('profileSel'), newProfile = $('newProfile'), renameProfile = $('renameProfile');
    const modeSel = $('modeSel'), dashCard = $('dashCard'), dashSummary = $('dashSummary'), dashTableBody = document.querySelector('#dashTable tbody');
    const exportCsv = $('exportCsv');

    // ====== UI 初期化 ======
    function refreshProfilesUI() {
      const map = loadProfiles();
      let cur = localStorage.getItem(CUR_KEY);
      if (!cur || !map[cur]) cur = Object.keys(map)[0];
      localStorage.setItem(CUR_KEY, cur);

      profileSel.innerHTML = '';
      Object.keys(map).forEach(n => {
        const o = document.createElement('option');
        o.value = o.textContent = n;
        profileSel.appendChild(o);
      });
      profileSel.value = cur;

      renderLog();
      renderDashboard();
    }

    newProfile.onclick = () => {
      const name = prompt('新しいプロフィール名');
      if (!name) return;
      const map = loadProfiles();
      if (map[name]) return alert('同名が存在します');
      map[name] = { log: [] };
      saveProfiles(map);
      localStorage.setItem(CUR_KEY, name);
      refreshProfilesUI();
    };

    renameProfile.onclick = () => {
      const map = loadProfiles();
      const cur = profileSel.value;
      const name = prompt('新しい名称', cur);
      if (!name || name === cur) return;
      if (map[name]) return alert('同名が存在します');
      map[name] = map[cur]; delete map[cur];
      saveProfiles(map);
      localStorage.setItem(CUR_KEY, name);
      refreshProfilesUI();
    };

    profileSel.onchange = () => {
      localStorage.setItem(CUR_KEY, profileSel.value);
      renderLog(); renderDashboard();
    };

    // 学習記録の表示切替
    toggleLog.onclick = () => {
      logVisible = !logVisible;
      logCard.classList.toggle('hidden', !logVisible);
      toggleLog.textContent = logVisible ? '非表示' : '表示';
    };
    toggleMs.onclick = () => {
      showMs = !showMs;
      toggleMs.textContent = showMs ? '▼ 詳細（時間ms）を非表示' : '▶ 詳細（時間ms）を表示';
      renderLog();
    };

    // モード切替（先生ダッシュ表示）
    modeSel.onchange = () => renderDashboard();

    // ====== 出題取得 ======
    async function fetchNext() {
      resultEl.textContent = '';
      ans.value = '';
      qEl.textContent = '（取得中…）';

      const unit = unitSel.value;
      const difficulty = diffSel.value;

      const t0 = performance.now();
      const res = await fetch(`${API_BASE}/problems/next?unit=${unit}&difficulty=${difficulty}`);
      const inst = await res.json();
      inst._t = { getStart: t0, getEnd: performance.now() };
      current = inst;
      qEl.textContent = inst.render.stem;
    }

    // ====== 採点 ======
    async function grade() {
      if (!current) return;
      const answer = ans.value.trim();
      if (!answer) return;

      const t0 = performance.now();
      const res = await fetch(`${API_BASE}/grade`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ template_id: current.template_id, answer, payload: current.payload })
      });
      const data = await res.json();
      const t1 = performance.now();

      // 表示
      if (data.ok && data.correct) {
        resultEl.innerHTML = `<span class="ok">⭕ 正解！</span>`;
      } else if (data.ok) {
        resultEl.innerHTML = `<span class="ng">❌ 不正解。</span> 正答：<span class="mono">${data.expected ?? '-'}</span>`;
      } else {
        resultEl.textContent = '採点エラー';
      }

      // 記録
      appendLog({
        stem: current.render.stem,
        unit: current.meta.unit,
        difficulty: current.meta.difficulty,
        correct: !!data.correct,
        expected: data.expected ?? null,
        ms: {
          get: Math.round(current._t.getEnd - current._t.getStart),
          answer: Math.round(t1 - t0)
        }
      });
      renderLog();
      renderDashboard();
    }

    // ログ追加
    function appendLog(entry) {
      const map = loadProfiles();
      const cur = localStorage.getItem(CUR_KEY);
      if (!map[cur]) map[cur] = { log: [] };
      map[cur].log.unshift({ at: Date.now(), ...entry });
      if (map[cur].log.length > 300) map[cur].log.length = 300;
      saveProfiles(map);
    }

    // ログ描画
    function renderLog() {
      const map = loadProfiles();
      const cur = localStorage.getItem(CUR_KEY);
      const rec = (map[cur]?.log) || [];
      const ok = rec.filter(r => r.correct).length;
      const rate = rec.length ? Math.round((ok / rec.length) * 100) : null;
      stats.textContent = rate == null ? '正答率：—' : `正答率：${rate}%（${ok}/${rec.length}）`;

      logUl.innerHTML = '';
      rec.forEach(r => {
        const li = document.createElement('li');
        const ms = showMs ? ` / 取得:${r.ms.get ?? '-'}ms / 解答:${r.ms.answer ?? '-'}ms` : '';
        const ans = r.correct ? '' : ` / 正答:${r.expected ?? '-'}`;
        li.textContent = `${r.correct ? '○' : '×'} ${r.stem}${ans}${ms}`;
        logUl.appendChild(li);
      });
    }

    // 先生ダッシュ
    function renderDashboard() {
      const teacher = modeSel.value === 'teacher';
      dashCard.classList.toggle('hidden', !teacher);
      if (!teacher) return;

      const map = loadProfiles();
      const names = Object.keys(map);

      let totalLogs = 0;
      dashTableBody.innerHTML = '';

      names.forEach(name => {
        const logs = map[name].log || [];
        const total = logs.length;
        const ok = logs.filter(l => l.correct).length;
        const acc = total ? Math.round((ok / total) * 100) : 0;

        const cnt = { fraction: { t:0, ok:0 }, gcd: { t:0, ok:0 } };
        logs.forEach(l => {
          if (l.unit === 'fraction') { cnt.fraction.t++; if (l.correct) cnt.fraction.ok++; }
          if (l.unit === 'gcd') { cnt.gcd.t++; if (l.correct) cnt.gcd.ok++; }
        });

        totalLogs += total;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px;">${name}</td>
          <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px; text-align:right;">${total}</td>
          <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px; text-align:right;">${ok}</td>
          <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px; text-align:right;">${acc}%</td>
          <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px; text-align:right;">${cnt.fraction.ok}/${cnt.fraction.t}</td>
          <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px; text-align:right;">${cnt.gcd.ok}/${cnt.gcd.t}</td>`;
        dashTableBody.appendChild(tr);
      });

      dashSummary.textContent = `登録プロファイル: ${names.length} / 記録総数: ${totalLogs}`;
    }

    // CSV
    exportCsv.onclick = () => {
      const map = loadProfiles();
      const names = Object.keys(map);
      const header = ['profile','at','unit','difficulty','stem','correct','expected','ms_get','ms_answer'];
      const lines = [header.join(',')];

      names.forEach(name => {
        (map[name].log || []).forEach(l => {
          lines.push([
            name,
            new Date(l.at).toISOString(),
            l.unit,
            l.difficulty,
            `"${(l.stem||'').replace(/"/g,'""')}"`,
            l.correct ? 1 : 0,
            l.expected ?? '',
            l.ms.get ?? '',
            l.ms.answer ?? ''
          ].join(','));
        });
      });

      const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'dashboard.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    // ボタン
    nextBtn.onclick = fetchNext;
    submit.onclick = grade;
    btnGt.onclick = () => { ans.value = '>'; grade(); };
    btnLt.onclick = () => { ans.value = '<'; grade(); };
    btnEq.onclick = () => { ans.value = '='; grade(); };
    ans.addEventListener('keydown', e => { if (e.key === 'Enter') grade(); });

    // 初期表示
    refreshProfilesUI();
    fetchNext();
  </script>
</body>
</html>
