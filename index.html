<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>オンライン問題（試作）</title>
  <style>
    :root {
      --gap: 14px;
      --radius: 14px;
      --ui: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      --mono: ui-monospace, "SFMono-Regular", Menlo, Monaco, Consolas, "Courier New", monospace;
      --bg: #fff;
      --fg: #111;
      --muted: #667085;
      --card: #fff;
      --stroke: #e5e7eb;
      --accent: #111827;
      --accent-weak: #334155;
    }
    * { box-sizing: border-box; }
    body {
      font-family: var(--ui);
      color: var(--fg);
      background: var(--bg);
      max-width: 960px;
      margin: 24px auto;
      padding: 0 16px 100px;
      line-height: 1.6;
    }
    h1 { font-size: clamp(22px, 3vw, 28px); margin: 0 0 16px; }
    .muted { color: var(--muted); }
    .row { display: flex; gap: var(--gap); flex-wrap: wrap; align-items: center; }
    .card {
      border: 1px solid var(--stroke);
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
    }
    label { display:block; font-weight: 600; margin-bottom: 6px; }
    input[type="text"]{
      width: 100%;
      height: 40px;
      border: 1px solid var(--stroke);
      border-radius: 10px;
      padding: 0 12px;
      font-size: 16px;
    }
    select, button {
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: #fff;
      padding: 0 12px;
      font-size: 15px;
      cursor: pointer;
    }
    button.primary {
      background: var(--accent);
      color: #fff;
      border: 1px solid var(--accent);
    }
    button.secondary {
      background: #fff;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    .badge { display:inline-block; padding: 2px 8px; border:1px solid #e5e7eb; border-radius: 999px; background:#f3f4f6; font-size:12px; }
    .mono { font-family: var(--mono); }
    .space-top { margin-top: 14px; }
    .w-100 { width: 100%; }
    .justify-between { display:flex; justify-content: space-between; align-items: center; }
    .right { text-align:right; }
    .hide { display:none !important; }

    /* 下部バー（先生モード & プロフィール切替） */
    .footer {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: #fff;
      border-top: 1px solid var(--stroke);
      box-shadow: 0 -4px 24px rgba(0,0,0,0.06);
    }
    .footer-inner {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      gap: var(--gap);
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .footer .row { gap: 8px; }

    /* 学習記録カード */
    #logCard .time { display: none; } /* デフォルトで時間(ms)は非表示 */
    #logDetailToggle { cursor:pointer; color: var(--accent-weak); text-decoration: underline; }
  </style>
</head>
<body>

  <h1>オンライン問題（試作）</h1>

  <!-- 学習者向け：単元・難易度・次の問題（最上段） -->
  <div class="card">
    <div class="row">
      <div>
        <label>単元</label>
        <select id="type">
          <option value="fraction_compare">分数の大小</option>
          <option value="gcd">最大公約数</option>
        </select>
      </div>
      <div>
        <label>難易度</label>
        <select id="level">
          <option value="1">やさしい</option>
          <option value="2" selected>ふつう</option>
          <option value="3">むずかしい</option>
        </select>
      </div>
      <div style="margin-left:auto">
        <label class="muted">　</label>
        <button id="next" class="secondary">次の問題</button>
      </div>
      <div>
        <label class="muted">学習記録</label>
        <button id="toggleLog" class="secondary">表示</button>
      </div>
    </div>
  </div>

  <!-- 問題 -->
  <div class="card space-top">
    <div class="row justify-between">
      <div class="badge">問題</div>
      <div class="muted mono" id="unitHint"></div>
    </div>
    <div id="question" style="margin-top:12px; font-size:18px;">問題を取得中…</div>
  </div>

  <!-- 答え -->
  <div class="card space-top">
    <label>答え</label>
    <div class="row" id="cmpRow" style="gap:8px;">
      <button class="secondary" id="btn_gt" aria-label="＞で答える">&gt;</button>
      <button class="secondary" id="btn_lt" aria-label="＜で答える">&lt;</button>
      <button class="secondary" id="btn_eq" aria-label="＝で答える">=</button>
    </div>

    <div class="row space-top">
      <input id="answer" type="text" class="w-100" placeholder="例: > / < / =（分数の大小） または 例: 24 と 36 の最大公約数 を半角数字で" />
      <button id="submit" class="primary">採点</button>
    </div>

    <div id="result" class="space-top"></div>
  </div>

  <!-- 学習記録（トグルで表示/非表示） -->
  <div id="logCard" class="card space-top hide">
    <div class="justify-between">
      <div class="badge">学習記録</div>
      <div id="logDetailToggle">▶ 詳細（時間ms）を表示</div>
    </div>
    <div id="log" class="mono" style="margin-top:8px;"></div>
    <div class="muted" id="rate" style="margin-top:8px;">正答率：ー</div>
  </div>

  <!-- 画面下部の先生モード＆プロフィール切替 -->
  <div class="footer">
    <div class="footer-inner">
      <div class="row">
        <label class="muted">プロフィール</label>
        <select id="profile"></select>
        <button id="newProfile" class="secondary">新規プロフィール</button>
        <button id="renameProfile" class="secondary">名称変更</button>
      </div>

      <div class="row">
        <label class="muted">モード</label>
        <select id="mode">
          <option value="student" selected>学習者</option>
          <option value="teacher">先生</option>
        </select>
      </div>
    </div>
  </div>

<script>
/** ============================
 *  APIエンドポイント
 *  ============================ */
const API = 'https://nlt-proto.onrender.com/api/v1'; // ←必要ならあなたのRender URLに変更

/** ============================
 *  状態
 *  ============================ */
let current = null;
let speakingHintText = ''; // （読み上げ撤去したので未使用だが残骸があっても挙動に影響なし）
const state = {
  profileKey: 'learner_profiles_v1',
  selectedProfile: '',
  profiles: {},                // { profileName: { logs:[], correct:0, total:0 } }
  showLog: false,
  showMs: false
};

/** ============================
 *  プロフィール（ローカル保存）
 *  ============================ */
function loadProfiles(){
  const raw = localStorage.getItem(state.profileKey);
  state.profiles = raw ? JSON.parse(raw) : {};
  const names = Object.keys(state.profiles);
  if (names.length === 0) {
    state.profiles['学習者A'] = { logs:[], correct:0, total:0 };
    state.selectedProfile = '学習者A';
    saveProfiles();
  } else {
    state.selectedProfile = state.selectedProfile || names[0];
  }
  renderProfileSelect();
}
function saveProfiles(){
  localStorage.setItem(state.profileKey, JSON.stringify(state.profiles));
}
function renderProfileSelect(){
  const sel = document.getElementById('profile');
  sel.innerHTML = '';
  Object.keys(state.profiles).forEach(name=>{
    const opt = document.createElement('option');
    opt.value = name; opt.textContent = name;
    if (name === state.selectedProfile) opt.selected = true;
    sel.appendChild(opt);
  });
}
document.getElementById('profile').addEventListener('change', (e)=>{
  state.selectedProfile = e.target.value;
  refreshLog();
});
document.getElementById('newProfile').addEventListener('click', ()=>{
  const name = prompt('新しいプロフィール名');
  if (!name) return;
  if (state.profiles[name]) { alert('既に存在します'); return; }
  state.profiles[name] = { logs:[], correct:0, total:0 };
  state.selectedProfile = name;
  saveProfiles(); renderProfileSelect(); refreshLog();
});
document.getElementById('renameProfile').addEventListener('click', ()=>{
  const old = state.selectedProfile;
  const name = prompt('新しい名称', old);
  if (!name || name === old) return;
  if (state.profiles[name]) { alert('同名が存在します'); return; }
  state.profiles[name] = state.profiles[old];
  delete state.profiles[old];
  state.selectedProfile = name;
  saveProfiles(); renderProfileSelect(); refreshLog();
});

/** ============================
 *  画面表示の切替
 *  ============================ */
function setCompareRowByType(){
  const type = document.getElementById('type').value;
  const row = document.getElementById('cmpRow');
  const unit = document.getElementById('unitHint');
  if (type === 'fraction_compare') {
    row.style.display = 'flex';
    document.getElementById('answer').placeholder = '例: > / < / =（分数の大小）';
    unit.textContent = '（>, <, = のいずれかで答えます）';
  } else {
    row.style.display = 'none';
    document.getElementById('answer').placeholder = '例: 最大公約数を半角数字で';
    unit.textContent = '（半角数字で答えます）';
  }
}

/** ============================
 *  API
 *  ============================ */
async function fetchNext(){
  const type = document.getElementById('type').value;
  const level = document.getElementById('level').value;

  setCompareRowByType();

  const res = await fetch(`${API}/problems/next?type=${encodeURIComponent(type)}&level=${level}`);
  current = await res.json();
  current._start = Date.now();

  document.getElementById('question').textContent = current.render?.stem || '取得失敗';
  document.getElementById('answer').value = '';
  document.getElementById('result').textContent = '';
}

async function grade(answerText){
  if (!current) return;
  try{
    const res = await fetch(`${API}/grade`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        answer: answerText,
        payload: current.payload,
        template_id: current.template_id
      })
    });
    const g = await res.json();

    // 表示
    const ms = Date.now() - current._start;
    const ok = !!g?.correct;
    document.getElementById('result').innerHTML =
      ok ? `✅ 正解！` : `❌ 不正解。正答: <span class="mono">${g?.gold || '—'}</span>`;

    // ログ蓄積
    const prof = state.profiles[state.selectedProfile];
    prof.total++; if (ok) prof.correct++;
    const item = {
      t: new Date().toISOString(),
      stem: current.render?.stem || '',
      ms, ok,
      gold: g?.gold ?? ''
    };
    prof.logs.unshift(item);
    prof.logs = prof.logs.slice(0, 500); // 上限
    saveProfiles();
    refreshLog();

    // 次の問題へ
    current = null;

  } catch(err){
    console.error(err);
    alert('採点に失敗しました。通信状況をご確認ください。');
  }
}

/** ============================
 *  学習記録
 *  ============================ */
function refreshLog(){
  const prof = state.profiles[state.selectedProfile];
  // 正答率
  const rate = prof.total ? Math.round((prof.correct / prof.total) * 100) : 0;
  document.getElementById('rate').textContent = `正答率：${prof.total? rate+'%': 'ー'}`;

  // リスト
  const logEl = document.getElementById('log');
  logEl.innerHTML = '';
  prof.logs.forEach(item=>{
    const li = document.createElement('div');
    li.innerHTML = `• ${item.ok?'○':'×'} <span class="mono">${escapeHtml(item.stem)}</span>
      <span class="time muted"> / ${item.ms}ms</span>
      ${item.ok ? '' : ` / 正答: <span class="mono">${escapeHtml(item.gold)}</span>`}`;
    logEl.appendChild(li);
  });
}

// ms表示のトグル（先生の詳細確認向け）
document.getElementById('logDetailToggle').addEventListener('click', ()=>{
  state.showMs = !state.showMs;
  const on = state.showMs;
  document.getElementById('logDetailToggle').textContent =
    (on ? '▼ 詳細（時間ms）を非表示' : '▶ 詳細（時間ms）を表示');
  document.querySelectorAll('#logCard .time').forEach(el=>{
    el.style.display = on ? 'inline' : 'none';
  });
});

/** ============================
 *  ユーティリティ
 *  ============================ */
function escapeHtml(s){
  return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

/** ============================
 *  イベント
 *  ============================ */
document.getElementById('type').addEventListener('change', fetchNext);
document.getElementById('level').addEventListener('change', fetchNext);
document.getElementById('next').addEventListener('click', fetchNext);

// 比較ボタン
document.getElementById('btn_gt').addEventListener('click', ()=>grade('>'));
document.getElementById('btn_lt').addEventListener('click', ()=>grade('<'));
document.getElementById('btn_eq').addEventListener('click', ()=>grade('='));

// 手入力採点
document.getElementById('submit').addEventListener('click', ()=>{
  const a = document.getElementById('answer').value.trim();
  if (!a) return;
  grade(a);
});
document.getElementById('answer').addEventListener('keydown',(e)=>{
  if (e.key==='Enter'){ e.preventDefault(); document.getElementById('submit').click(); }
});

// 学習記録の表示/非表示トグル
document.getElementById('toggleLog').addEventListener('click', ()=>{
  state.showLog = !state.showLog;
  document.getElementById('logCard').classList.toggle('hide', !state.showLog);
  document.getElementById('toggleLog').textContent = state.showLog ? '非表示' : '表示';
});

// モード切替（現時点ではUI配置のみ。将来拡張のフック）
document.getElementById('mode').addEventListener('change', (e)=>{
  // 先生モードでも基本UIは同じ。必要に応じてここに“先生だけの機能”を後で生やす。
});

/** 初期化 */
loadProfiles();
setCompareRowByType();
refreshLog();
fetchNext();
</script>
</body>
</html>
