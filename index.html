<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>オンライン問題（試作）</title>
  <style>
    :root {
      --gap: 14px;
      --radius: 14px;
      --ui: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      --mono: ui-monospace, "SFMono-Regular", Menlo, Monaco, Consolas, "Courier New", monospace;
      --bg: #fff;
      --fg: #111;
      --muted: #667085;
      --card: #fff;
      --stroke: #e5e7eb;
      --accent: #111827;
      --accent-weak: #334155;
    }
    * { box-sizing: border-box; }
    body {
      font-family: var(--ui);
      color: var(--fg);
      background: var(--bg);
      max-width: 960px;
      margin: 24px auto;
      padding: 0 16px 100px;
      line-height: 1.6;
    }
    h1 { font-size: clamp(22px, 3vw, 28px); margin: 0 0 16px; }
    .muted { color: var(--muted); }
    .row { display: flex; gap: var(--gap); flex-wrap: wrap; align-items: center; }
    .card {
      border: 1px solid var(--stroke);
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
    }
    label { display:block; font-weight: 600; margin-bottom: 6px; }
    input[type="text"]{
      width: 100%;
      height: 40px;
      border: 1px solid var(--stroke);
      border-radius: 10px;
      padding: 0 12px;
      font-size: 16px;
    }
    select, button {
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: #fff;
      padding: 0 12px;
      font-size: 15px;
      cursor: pointer;
    }
    button.primary {
      background: var(--accent);
      color: #fff;
      border: 1px solid var(--accent);
    }
    button.secondary {
      background: #fff;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    .badge { display:inline-block; padding: 2px 8px; border:1px solid #e5e7eb; border-radius: 999px; background:#f3f4f6; font-size:12px; }
    .mono { font-family: var(--mono); }
    .space-top { margin-top: 14px; }
    .w-100 { width: 100%; }
    .justify-between { display:flex; justify-content: space-between; align-items: center; }
    .right { text-align:right; }
    .hide { display:none !important; }

    /* 下部バー（先生モード & プロフィール切替） */
    .footer {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: #fff;
      border-top: 1px solid var(--stroke);
      box-shadow: 0 -4px 24px rgba(0,0,0,0.06);
    }
    .footer-inner {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      gap: var(--gap);
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .footer .row { gap: 8px; }

    /* 学習記録カード */
    #logCard .time { display: none; } /* デフォルトで時間(ms)は非表示 */
    #logDetailToggle { cursor:pointer; color: var(--accent-weak); text-decoration: underline; }
  </style>
</head>
<body>

  <h1>オンライン問題（試作）</h1>

  <!-- 学習者向け：単元・難易度・次の問題（最上段） -->
  <div class="card">
    <div class="row">
      <div>
        <label>単元</label>
        <select id="type">
          <option value="fraction_compare">分数の大小</option>
          <option value="gcd">最大公約数</option>
        </select>
      </div>
      <div>
        <label>難易度</label>
        <select id="level">
          <option value="1">やさしい</option>
          <option value="2" selected>ふつう</option>
          <option value="3">むずかしい</option>
        </select>
      </div>
      <div style="margin-left:auto">
        <label class="muted">　</label>
        <button id="next" class="secondary">次の問題</button>
      </div>
      <div>
        <label class="muted">学習記録</label>
        <button id="toggleLog" class="secondary">表示</button>
      </div>
    </div>
  </div>

  <!-- 問題 -->
  <div class="card space-top">
    <div class="row justify-between">
      <div class="badge">問題</div>
      <div class="muted mono" id="unitHint"></div>
    </div>
    <div id="question" style="margin-top:12px; font-size:18px;">問題を取得中…</div>
  </div>

  <!-- 答え -->
  <div class="card space-top">
    <label>答え</label>
    <div class="row" id="cmpRow" style="gap:8px;">
      <button class="secondary" id="btn_gt" aria-label="＞で答える">&gt;</button>
      <button class="secondary" id="btn_lt" aria-label="＜で答える">&lt;</button>
      <button class="secondary" id="btn_eq" aria-label="＝で答える">=</button>
    </div>

    <div class="row space-top">
      <input id="answer" type="text" class="w-100" placeholder="例: > / < / =（分数の大小） または 例: 24 と 36 の最大公約数 を半角数字で" />
      <button id="submit" class="primary">採点</button>
    </div>

    <div id="result" class="space-top"></div>
  </div>

  <!-- 学習記録（トグルで表示/非表示） -->
  <div id="logCard" class="card space-top hide">
    <div class="justify-between">
      <div class="badge">学習記録</div>
      <div id="logDetailToggle">▶ 詳細（時間ms）を表示</div>
    </div>
    <div id="log" class="mono" style="margin-top:8px;"></div>
    <div class="muted" id="rate" style="margin-top:8px;">正答率：ー</div>
  </div>

  <!-- 画面下部の先生モード＆プロフィール切替 -->
  <div class="footer">
    <div class="footer-inner">
      <div class="row">
        <label class="muted">プロフィール</label>
        <select id="profile"></select>
        <button id="newProfile" class="secondary">新規プロフィール</button>
        <button id="renameProfile" class="secondary">名称変更</button>
      </div>

      <div class="row">
        <label class="muted">モード</label>
        <select id="mode">
          <option value="student" selected>学習者</option>
          <option value="teacher">先生</option>
        </select>
      </div>
    </div>
  </div>

<script>
  const API_BASE = 'https://nlt-proto.onrender.com/api/v1';

  // ==== 状態 ====
  let current = null;   // 出題インスタンス
  let showMs = false;   // 学習記録のms表示
  let logVisible = false;

  // ---- プロフィール（localStorage: nlt-proto:profiles） ----
  const storeKey = 'nlt-proto:profiles';
  function loadProfiles() {
    try { return JSON.parse(localStorage.getItem(storeKey)) ?? {}; }
    catch { return {}; }
  }
  function saveProfiles(map) { localStorage.setItem(storeKey, JSON.stringify(map)); }
  function firstProfileName(map) { return Object.keys(map)[0] || '学習者A'; }
  function ensureInit() {
    const map = loadProfiles();
    if (!Object.keys(map).length) {
      map['学習者A'] = { log: [] };
      saveProfiles(map);
    }
  }
  ensureInit();

  // ---- 要素参照（IDは既存HTMLに合わせてください）----
  const $ = (id) => document.getElementById(id);
  const profileSel = $('profileSel');
  const newProfileBtn = $('newProfile');
  const renameBtn = $('renameProfile');
  const modeSel = $('modeSel');

  const unitSel = $('unit');
  const diffSel = $('difficulty');
  const nextBtn = $('next');
  const qEl = $('question');
  const ansInput = $('answer');
  const resultEl = $('result');
  const submitBtn = $('submit');

  const btnGt = $('btnGt');
  const btnLt = $('btnLt');
  const btnEq = $('btnEq');

  const logCard = $('logCard');
  const toggleLogBtn = $('toggleLog');
  const logUl = $('log');
  const statsEl = $('stats');
  const toggleMsBtn = $('toggleMs');

  // ==== 先生ダッシュボード（下部カードの直前に挿入）====
  const dashCard = document.createElement('div');
  dashCard.className = 'card section hidden';
  dashCard.id = 'dashCard';
  dashCard.innerHTML = `
    <div class="toolbar">
      <div class="tiny muted">先生ダッシュボード（この端末に登録されたプロフィールの集計）</div>
      <div class="right">
        <button id="exportCsv" class="secondary tiny">CSVエクスポート</button>
      </div>
    </div>
    <div id="dashSummary" class="mono tiny muted" style="margin-top:6px;"></div>
    <div style="overflow-x:auto; margin-top:8px;">
      <table id="dashTable" class="mono" style="border-collapse:collapse; width:100%;">
        <thead>
          <tr>
            <th style="border-bottom:1px solid #e5e7eb; text-align:left; padding:4px 6px;">プロフィール</th>
            <th style="border-bottom:1px solid #e5e7eb; text-align:right; padding:4px 6px;">総問数</th>
            <th style="border-bottom:1px solid #e5e7eb; text-align:right; padding:4px 6px;">正解</th>
            <th style="border-bottom:1px solid #e5e7eb; text-align:right; padding:4px 6px;">正答率</th>
            <th style="border-bottom:1px solid #e5e7eb; text-align:right; padding:4px 6px;">分数の大小</th>
            <th style="border-bottom:1px solid #e5e7eb; text-align:right; padding:4px 6px;">最大公約数</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>`;
  // 「プロフィール」カードの直前に追加（最下部にある card.section の直前）
  const sections = document.querySelectorAll('.card.section');
  if (sections.length) {
    sections[sections.length - 1].before(dashCard);
  }

  // ---- プロフィールUI ----
  function refreshProfileUI() {
    const map = loadProfiles();
    const cur = localStorage.getItem('nlt-proto:currentProfile') || firstProfileName(map);
    if (profileSel) {
      profileSel.innerHTML = '';
      Object.keys(map).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name; profileSel.appendChild(opt);
      });
      profileSel.value = cur;
    }
    localStorage.setItem('nlt-proto:currentProfile', cur);
    renderLog();
    renderDashboard();
  }

  if (newProfileBtn) newProfileBtn.onclick = () => {
    const name = prompt('新しいプロフィール名');
    if (!name) return;
    const map = loadProfiles();
    if (map[name]) { alert('同名が存在します'); return; }
    map[name] = { log: [] };
    saveProfiles(map);
    localStorage.setItem('nlt-proto:currentProfile', name);
    refreshProfileUI();
  };

  if (renameBtn) renameBtn.onclick = () => {
    const map = loadProfiles();
    const cur = profileSel.value;
    const name = prompt('新しい名称', cur);
    if (!name || name === cur) return;
    if (map[name]) { alert('同名が存在します'); return; }
    map[name] = map[cur]; delete map[cur];
    saveProfiles(map);
    localStorage.setItem('nlt-proto:currentProfile', name);
    refreshProfileUI();
  };

  if (profileSel) profileSel.onchange = () => {
    localStorage.setItem('nlt-proto:currentProfile', profileSel.value);
    renderLog(); renderDashboard();
  };

  // ---- 学習記録表示切替 ----
  if (toggleLogBtn && logCard) {
    toggleLogBtn.onclick = () => {
      logVisible = !logVisible;
      logCard.classList.toggle('hidden', !logVisible);
      toggleLogBtn.textContent = logVisible ? '非表示' : '表示';
    };
  }
  if (toggleMsBtn) {
    toggleMsBtn.onclick = () => {
      showMs = !showMs;
      toggleMsBtn.textContent = showMs ? '▼ 詳細（時間ms）を非表示' : '▶ 詳細（時間ms）を表示';
      renderLog();
    };
  }

  // ---- 出題取得 ----
  async function fetchNext() {
    if (resultEl) resultEl.textContent = '';
    if (ansInput) ansInput.value = '';
    const unit = unitSel && unitSel.value === 'gcd' ? 'gcd' : 'fraction';
    const difficulty = diffSel ? diffSel.value : 'normal';
    if (qEl) qEl.textContent = '（取得中…）';
    try {
      const t0 = performance.now();
      const res = await fetch(`${API_BASE}/problems/next?unit=${unit}&difficulty=${difficulty}`);
      const inst = await res.json();
      current = inst;
      if (qEl) qEl.textContent = inst.render.stem;
      current._t = { t0, t1: performance.now() };
    } catch (e) {
      if (qEl) qEl.textContent = '問題取得に失敗しました。通信状況をご確認ください。';
    }
  }

  // ---- 採点 ----
  async function grade() {
    if (!current) return;
    const answer = ansInput ? ansInput.value.trim() : '';
    if (!answer) return;
    const tStart = performance.now();
    try {
      const res = await fetch(`${API_BASE}/grade`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ template_id: current.template_id, answer, payload: current.payload }),
      });
      const data = await res.json();
      if (!data.ok) throw new Error('採点エラー');

      // 正答表示
      if (resultEl) {
        if (data.correct) {
          resultEl.textContent = '⭕ 正解！';
        } else {
          const expected = data.expected ?? computeExpectedFallback(current);
          resultEl.textContent = `❌ 不正解。 正答: ${expected}`;
        }
      }

      appendLogEntry(data.correct, tStart, data.expected ?? computeExpectedFallback(current));
      renderLog(); renderDashboard();
    } catch (e) {
      alert('採点に失敗しました。通信状況をご確認ください。');
    }
  }

  // サーバが古い場合のフォールバック計算
  function computeExpectedFallback(inst) {
    if (!inst) return '-';
    if (inst.template_id === 'math_frac_compare_v1') {
      const {A,B,C,D} = inst.payload;
      const lhs = A*D, rhs = C*B;
      return lhs > rhs ? '>' : lhs < rhs ? '<' : '=';
    }
    if (inst.template_id === 'math_gcd_v1') {
      let {X,Y} = inst.payload;
      X = Math.abs(X); Y = Math.abs(Y);
      while (Y) [X,Y] = [Y, X % Y];
      return String(X);
    }
    return '-';
  }

  function appendLogEntry(correct, tStart, expected) {
    const map = loadProfiles();
    const name = localStorage.getItem('nlt-proto:currentProfile') || firstProfileName(map);
    const rec = map[name] ?? { log: [] };
    const spentMs = Math.round(performance.now() - tStart);
    const getMs = current?._t ? Math.round(current._t.t1 - current._t.t0) : null;
    rec.log.unshift({
      at: Date.now(),
      unit: current.meta.unit,
      diff: current.meta.difficulty,
      stem: current.render.stem,
      correct: !!correct,
      expected: expected ?? null,
      ms: { fetch: getMs, answer: spentMs }
    });
    if (rec.log.length > 200) rec.log.length = 200;
    map[name] = rec;
    saveProfiles(map);
  }

  function renderLog() {
    if (!statsEl || !logUl) return;
    const map = loadProfiles();
    const name = localStorage.getItem('nlt-proto:currentProfile') || firstProfileName(map);
    const rec = map[name] ?? { log: [] };

    if (!rec.log.length) {
      statsEl.textContent = '正答率：—';
    } else {
      const ok = rec.log.filter(r => r.correct).length;
      const rate = Math.round((ok / rec.log.length) * 100);
      statsEl.textContent = `正答率：${rate}%（${ok}/${rec.log.length}）`;
    }

    logUl.innerHTML = '';
    rec.log.forEach(r => {
      const li = document.createElement('li');
      const head = (r.correct ? '○' : '×') + ' ' + r.stem;
      const tailMs = showMs ? ` / 取得:${r.ms.fetch ?? '-'}ms / 解答:${r.ms.answer}ms` : '';
      const tailAns = r.correct ? '' : ` / 正答: ${r.expected ?? '-'}`;
      li.textContent = `${head}${tailAns}${tailMs}`;
      logUl.appendChild(li);
    });
  }

  // ---- 先生ダッシュボード ----
  function summarize(map) {
    const rows = [];
    for (const name of Object.keys(map)) {
      const logs = map[name].log ?? [];
      const total = logs.length;
      const ok = logs.filter(r => r.correct).length;
      const acc = total ? Math.round((ok/total)*100) : 0;
      const byUnit = { fraction: {t:0,ok:0}, gcd:{t:0,ok:0} };
      logs.forEach(r => {
        if (r.unit === 'fraction') { byUnit.fraction.t++; if (r.correct) byUnit.fraction.ok++; }
        if (r.unit === 'gcd') { byUnit.gcd.t++; if (r.correct) byUnit.gcd.ok++; }
      });
      rows.push({ name, total, ok, acc,
        frac:`${byUnit.fraction.ok}/${byUnit.fraction.t}`,
        gcd:`${byUnit.gcd.ok}/${byUnit.gcd.t}` });
    }
    return rows;
  }

  function renderDashboard() {
    const map = loadProfiles();
    const rows = summarize(map);

    const tableBody = document.querySelector('#dashTable tbody');
    const sumEl = document.getElementById('dashSummary');
    if (!tableBody || !sumEl) return;

    // サマリー
    const totals = Object.values(map).map(p => p.log?.length ?? 0).reduce((a,b)=>a+b,0);
    sumEl.textContent = `登録プロファイル: ${Object.keys(map).length} / 記録総数: ${totals}`;

    // 行
    tableBody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px;">${r.name}</td>
        <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px; text-align:right;">${r.total}</td>
        <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px; text-align:right;">${r.ok}</td>
        <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px; text-align:right;">${r.acc}%</td>
        <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px; text-align:right;">${r.frac}</td>
        <td style="border-bottom:1px solid #f3f4f6; padding:4px 6px; text-align:right;">${r.gcd}</td>`;
      tableBody.appendChild(tr);
    });

    // CSV
    const exportBtn = document.getElementById('exportCsv');
    if (exportBtn) exportBtn.onclick = () => {
      const header = ['profile','total','correct','accuracy(%)','fraction(ok/total)','gcd(ok/total)'];
      const lines = [header.join(',')];
      rows.forEach(r => lines.push([r.name, r.total, r.ok, r.acc, r.frac, r.gcd].join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'dashboard.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    // モードに応じて表示
    const isTeacher = (modeSel && modeSel.value === 'teacher');
    dashCard.classList.toggle('hidden', !isTeacher);
  }

  // モード切替
  if (modeSel) modeSel.onchange = () => { renderDashboard(); };

  // ボタン
  if (nextBtn) nextBtn.onclick = fetchNext;
  if (submitBtn) submitBtn.onclick = grade;
  if (btnGt) btnGt.onclick = () => { if (ansInput) ansInput.value = '>'; grade(); };
  if (btnLt) btnLt.onclick = () => { if (ansInput) ansInput.value = '<'; grade(); };
  if (btnEq) btnEq.onclick = () => { if (ansInput) ansInput.value = '='; grade(); };
  if (ansInput) ansInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') grade(); });

  // 初期化
  refreshProfileUI();
  fetchNext();
  renderDashboard();
</script>
</body>
</html>
